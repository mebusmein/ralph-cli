# Ralph Progress Log
Started: 2026-01-13

## Codebase Patterns
- Using Ink (React) for TUI components
- TypeScript with ESM modules
- meow for CLI argument parsing
- Project uses xo + prettier for linting/formatting
- Tests use ava with ts-node

## Key Files
- source/cli.tsx - CLI entry point
- source/app.tsx - Main React component
- package.json - Uses "type": "module"
- tsconfig.json - Extends @sindresorhus/tsconfig

## Reference Implementation
- ../ralph/ralph.sh - Main script structure
- ../ralph/lib/execution.sh - Claude execution and output parsing
- ../ralph/lib/prd.sh - PRD handling logic

---

## 2026-01-13 - US-001
- What was implemented: Project structure and types for the entire application
- Files changed:
  - source/types/prd.ts - PRD schema types (UserStory, PRDConfig)
  - source/types/state.ts - Application state types (AppState, StoryStatus, etc.)
  - source/types/config.ts - Configuration types (RalphPaths, CLIFlags, Claude event types)
  - source/types/index.ts - Barrel export file
  - Created folders: source/components, source/hooks, source/utils, source/lib
- **Learnings:**
  - The project uses ESM modules so imports need `.js` extension (e.g., `./prd.js`)
  - TypeScript extends @sindresorhus/tsconfig which has strict settings
  - xo + prettier handle linting/formatting with "prettier": true in xo config
---

## 2026-01-13 - US-002
- What was implemented: Setup checker utility functions
- Files changed:
  - source/utils/setup-checker.ts - Core setup checking functions
  - source/utils/index.ts - Barrel export for utils
  - source/types/state.ts - Prettier formatting fix
- **Learnings:**
  - Types for SetupCheckItem and SetupCheckResult already existed in config.ts
  - Use `existsSync` from `node:fs` for synchronous file/directory existence checks
  - The xo linter has a pre-existing bug with the `unicorn/expiring-todo-comments` rule that causes crashes
  - Always run `npx prettier --write` on new files before committing
  - Barrel exports use `.js` extension in ESM: `export * from './setup-checker.js'`
---

## 2026-01-13 - US-003
- What was implemented: Setup scaffolding utility functions for creating Ralph project structure
- Files changed:
  - source/utils/setup-scaffolding.ts - Scaffolding functions and bundled templates
  - source/utils/index.ts - Added barrel export for setup-scaffolding
- **Learnings:**
  - Use `mkdirSync(path, {recursive: true})` for idempotent directory creation
  - `dirname()` from `node:path` is useful for ensuring parent directories exist before writing files
  - Templates can be bundled as string constants in TypeScript for simpler packaging
  - Keep functions idempotent by checking existence before creating (return early if exists)
  - TypeScript strict mode catches unused imports - remove them before committing
  - The progress.txt template uses dynamic date: `new Date().toISOString().split('T')[0]`
---

## 2026-01-13 - US-004
- What was implemented: Setup Wizard Ink component for interactive setup flow
- Files changed:
  - source/components/SetupWizard.tsx - Main wizard component with multi-step flow
  - source/components/index.ts - Barrel export for components
- **Learnings:**
  - Ink's `useInput` hook handles keyboard input with input string and key object
  - Ink's `useApp` provides `exit()` function for graceful app termination
  - Use `useState` with step enum to manage wizard flow states (checking, prompt, scaffolding, complete, error)
  - Component state updates in sequence can be tracked with partial status objects
  - Ink components use `Box` for layout (flexbox model) and `Text` for styled text output
  - The `marginY` and `marginLeft` props on Box provide spacing in terminal UI
  - ScaffoldResult type already exported from setup-scaffolding.ts, can be imported with `type` keyword
---

## 2026-01-13 - US-005
- What was implemented: PRD file reader and parser with validation
- Files changed:
  - source/lib/prd-reader.ts - Main reader function with JSON validation
  - source/lib/index.ts - Barrel export for lib directory
- **Learnings:**
  - TypeScript strict mode with @sindresorhus/tsconfig requires bracket notation for index signatures (e.g., `obj['key']` not `obj.key` when obj is `Record<string, unknown>`)
  - Use discriminated unions for Result types: `{success: true; config: PRDConfig} | {success: false; error: PRDReadError}`
  - Type guards (`obj is T` return type) enable safe narrowing after validation
  - For JSON parsing, cast unknown arrays before calling array methods: `(arr as unknown[]).every(...)`
  - NodeJS.ErrnoException has a `code` property for checking ENOENT (file not found)
---

## 2026-01-13 - US-006
- What was implemented: PRD file writer with functions to write full config and update individual story statuses
- Files changed:
  - source/lib/prd-writer.ts - Main writer functions (writePRDFile, updateStoryStatus)
  - source/lib/index.ts - Added barrel export for prd-writer
- **Learnings:**
  - Use `JSON.stringify(obj, null, '\t')` for tab-based pretty printing that matches existing prd.json format
  - Append `+ '\n'` to JSON output to ensure file ends with newline
  - The `updateStoryStatus` function composes read + modify + write for atomic story updates
  - TypeScript strict mode requires checking `story` existence after `findIndex` even though we already validated the index
  - Result types should use different error types: `write_failed`, `story_not_found`, `read_failed` for clear error handling
---

## 2026-01-13 - US-007
- What was implemented: TicketList Ink component for displaying user stories with status
- Files changed:
  - source/components/TicketList.tsx - Main component with scrollable list
  - source/components/index.ts - Added barrel export for TicketList
- **Learnings:**
  - Ink's `Text` component supports `dimColor` prop for grayed-out pending items
  - Use `useMemo` for calculating scroll position to avoid recalculation on every render
  - Status indicators with unicode characters (✓, ▶, ✗, ○) work well in terminal UIs
  - For scrollable lists, calculate visible window based on `maxHeight` and keep current item centered
  - Export default components and re-export from barrel file: `export {default as TicketList} from './TicketList.js'`
  - Color coding for statuses: green=passed, yellow=in-progress, red=failed, gray=pending
---

## 2026-01-13 - US-008
- What was implemented: Claude CLI execution wrapper with process spawning and streaming output
- Files changed:
  - source/lib/claude-executor.ts - Main executor function with abort signal support
  - source/lib/index.ts - Added barrel export for claude-executor
- **Learnings:**
  - Use `spawn` from `node:child_process` with `shell: false` for safer process execution
  - AbortSignal integration: register handler with `signal.addEventListener('abort', handler, {once: true})`
  - Clean up abort listeners in the `exit` event to prevent memory leaks
  - Check `signal.aborted` before starting to handle pre-aborted signals
  - Use `stdio: ['ignore', 'pipe', 'pipe']` to ignore stdin but capture stdout/stderr
  - ChildProcess `exit` event provides `code` (number|null) and `signal` (string|null) parameters
  - Capture stderr output for better error messages when process fails
  - The `--print` flag is required to pass the prompt to Claude CLI
---

## 2026-01-13 - US-009
- What was implemented: Output parser for Claude stream-json format
- Files changed:
  - source/lib/output-parser.ts - Stream parsing functions (parseStreamLine, parseStreamChunk, createStreamParser)
  - source/lib/index.ts - Added barrel export for output-parser
- **Learnings:**
  - Claude stream-json format outputs one JSON object per line with `type` field
  - Use `METADATA_EVENT_TYPES` array to filter out non-content events (system, message_start, content_block_start, etc.)
  - The `content_block_delta` event has nested structure: `delta.type === 'text_delta'` with `delta.text` containing actual text
  - The `result` event contains `is_error`, `duration_ms`, and `cost_usd` for summarizing execution
  - Use empty `catch` block (not `catch(error)`) to avoid TypeScript unused variable warning
  - For streaming chunks, buffer incomplete lines at the end to handle JSON split across chunks
  - Factory function pattern (`createStreamParser`) works well for stateful parsers that need to accumulate output
  - Type casting with `as` is needed when parsing JSON since `JSON.parse` returns `unknown`
---

## 2026-01-13 - US-010
- What was implemented: OutputPanel Ink component for streaming output display
- Files changed:
  - source/components/OutputPanel.tsx - Main panel component with auto-scroll and configurable max lines
  - source/components/index.ts - Added barrel export for OutputPanel
- **Learnings:**
  - Ink's `Box` supports `borderStyle` and `borderColor` props for terminal borders
  - Use `wrap="truncate"` on `Text` to handle long lines that exceed terminal width
  - For auto-scrolling output, use `useMemo` to slice the last N lines from the array
  - Key generation for list items: use index + partial content to avoid duplicate keys
  - Empty state handling: show "Waiting for output..." message when lines array is empty
  - `flexGrow={1}` on Box makes the component expand to fill available space
---

## 2026-01-13 - US-011
- What was implemented: ProgressLog Ink component for displaying and live-tailing progress.txt
- Files changed:
  - source/components/ProgressLog.tsx - Main component with file watching and auto-scroll
  - source/components/index.ts - Added barrel export for ProgressLog
- **Learnings:**
  - Use `watchFile` and `unwatchFile` from `node:fs` for file change monitoring
  - `watchFile` accepts an `interval` option (in ms) to control polling frequency (500ms works well)
  - Cleanup is essential: call `unwatchFile` in useEffect cleanup function to prevent memory leaks
  - Handle file-not-found case separately from read errors for better user experience
  - Empty content check needs to handle both empty array and single-empty-string cases
  - Component structure mirrors OutputPanel for consistency in the codebase
---

## 2026-01-13 - US-012
- What was implemented: TabPanel Ink component with tab navigation for switching between Output and Progress Log views
- Files changed:
  - source/components/TabPanel.tsx - Main component with tab headers and content switching
  - source/components/index.ts - Added barrel export for TabPanel and TabId type
- **Learnings:**
  - Use `inverse` prop on Text for highlighted/active tab appearance in terminal UIs
  - Export component types alongside default exports: `export {default as TabPanel, type TabId}`
  - Tab panels compose child components (OutputPanel, ProgressLog) by passing empty `title=""` to suppress child titles
  - Use `gap` prop on Box for spacing between tab headers instead of margin on individual items
  - The `flexGrow={1}` with empty Box acts as a spacer to push help text to the right
---

## 2026-01-13 - US-013
- What was implemented: MainLayout Ink component with two-column layout for the main application view
- Files changed:
  - source/components/MainLayout.tsx - Main layout component composing TicketList and TabPanel
  - source/components/index.ts - Added barrel export for MainLayout
- **Learnings:**
  - Use `width="30%"` and `width="70%"` for percentage-based column sizing in Ink
  - Combine `flexGrow={1}` with percentage widths for flexible yet proportional layouts
  - Use `paddingRight={1}` for visual separation between columns in terminal UI
  - Layout components should pass through all necessary props to child components (stories, outputLines, etc.)
  - Re-export the `TabId` type from TabPanel when needed in layout component props
---

## 2026-01-13 - US-014
- What was implemented: IterationPrompt Ink component for prompting user for number of iterations
- Files changed:
  - source/components/IterationPrompt.tsx - Main prompt component with input validation
  - source/components/index.ts - Added barrel export for IterationPrompt
- **Learnings:**
  - Ink's `useInput` receives character as first arg and key object as second
  - Handle backspace/delete by slicing off last character from input state
  - Only allow digits by testing with `/^\d$/` regex before appending to input
  - Validation should happen on Enter: check for NaN, <= 0, and reasonable upper limit
  - Show cursor position with `{input || '_'}` pattern for empty state visibility
  - Keep validation messages in separate error state for clear conditional rendering
---

## 2026-01-13 - US-015
- What was implemented: Iteration execution loop for running multiple Claude iterations
- Files changed:
  - source/lib/iteration-executor.ts - Main executor with runIterations(), findNextIncompleteStory(), getStoriesWithStatus()
  - source/lib/index.ts - Added barrel export for iteration-executor
- **Learnings:**
  - Use `EventEmitter<T>` generic from `node:events` for typed event emitters in Node.js
  - Re-read PRD file at start of each iteration to get latest state (not just at start of loop)
  - Sort stories by priority after filtering to ensure highest priority incomplete is selected
  - EventEmitter pattern works well for decoupling execution logic from UI updates
  - Use `AbortSignal` for cancellation - check `signal?.aborted` before starting and pass to subprocess
  - Continue to next iteration even on error (unless aborted) for resilience
---

## 2026-01-13 - US-016
- What was implemented: Keyboard controls hook and footer component for main application
- Files changed:
  - source/hooks/useKeyboardControls.ts - Custom hook for keyboard handling with Tab, Ctrl+C, Ctrl+X, and 'q' keys
  - source/hooks/index.ts - Barrel export for hooks directory
  - source/components/KeyboardHelpFooter.tsx - Footer component showing keybinding help
  - source/components/index.ts - Added barrel export for KeyboardHelpFooter
- **Learnings:**
  - Ink's `useInput` hook accepts an options object with `isActive` for conditionally enabling input handling
  - Use `useApp()` hook to get the `exit()` function for immediate app termination
  - Export constants (KEYBOARD_HELP) alongside hooks for consistent help text across components
  - The xo linter bug with `unicorn/expiring-todo-comments` is still present; typecheck is the reliable verification
  - Separate callbacks for immediate cancel vs stop-after-iteration allows graceful shutdown handling
  - Custom hooks can import from component barrel exports (`../components/TabPanel.js`) for type reuse
---

## 2026-01-13 - US-017
- What was implemented: Prompt template loader with file loading and variable expansion
- Files changed:
  - source/lib/prompt-loader.ts - Main loader with loadPromptTemplate(), expandPromptVariables(), createPromptGenerator()
  - source/lib/index.ts - Added barrel export for prompt-loader
- **Learnings:**
  - Use `replaceAll()` for variable expansion (cleaner than chained `replace()` calls)
  - Return a result object with `source: 'file' | 'default'` to indicate where prompt came from
  - Factory function `createPromptGenerator()` provides integration point with iteration-executor
  - The default prompt template was already defined in setup-scaffolding.ts - duplicated here for fallback behavior
  - Empty `catch {}` block silently falls through to default on read error
---

## 2026-01-13 - US-018
- What was implemented: Full App component integration orchestrating setup, PRD loading, iteration execution, and UI state
- Files changed:
  - source/app.tsx - Complete rewrite with view-based state machine (setup, no-prd, iteration-prompt, running, complete)
  - source/cli.tsx - Updated to support positional iterations argument and new App props
  - test.ts - Updated tests to match new App behavior (renamed from .tsx to .ts)
- **Learnings:**
  - Use `useRef<AbortController | null>` to hold the abort controller reference for cancellation across renders
  - View-based state machine pattern (AppView type) cleanly separates UI states
  - EventEmitter pattern from iteration-executor integrates well with React state updates via `.on()` listeners
  - The `useCallback` hook with proper dependency arrays is essential for memoizing handlers that use state
  - Initial setup check should run in `useEffect` to properly handle SSR and re-renders
  - Test file extension matters: AVA + ts-node has issues with Node.js v24 - the xo linter bug extends to test infrastructure
  - Typecheck (`tsc --noEmit`) is the reliable verification when linter has bugs
---

## 2026-01-13 - US-019
- What was implemented: Bundled default templates module for runtime access
- Files changed:
  - source/templates/index.ts - New module exporting all default templates
  - source/utils/setup-scaffolding.ts - Refactored to import from templates module
  - source/lib/prompt-loader.ts - Refactored to import from templates module
- **Learnings:**
  - Create a centralized templates module to avoid duplication across files
  - Use `{{DATE}}` placeholder pattern with a factory function (`getProgressTemplate()`) for dynamic content
  - Export both individual templates and a convenience `templates` object for different import styles
  - Keep template strings as named exports for tree-shaking and explicit imports
  - The `as const` assertion on the templates object provides readonly type safety
---

## 2026-01-13 - US-022
- What was implemented: Stream formatter for Claude's stream-json CLI output
- Files changed:
  - source/lib/stream-formatter.ts - New module for parsing and formatting stream-json output
  - source/lib/index.ts - Added barrel export for stream-formatter
  - source/lib/iteration-executor.ts - Integrated stream formatter into execution loop
- **Learnings:**
  - Claude's stream-json format has top-level types: `system`, `assistant`, `user`, `result`
  - `assistant` messages have `content` arrays with `text` or `tool_use` items
  - `user` messages have `content` arrays with `tool_result` items
  - Use ANSI escape codes for terminal colors: `\x1b[36m` for cyan, `\x1b[31m` for red, `\x1b[32m` for green, `\x1b[0m` for reset
  - Keep a constants object for colors to avoid magic strings throughout the code
  - Use `as const` on the COLORS object for TypeScript string literal types
  - Truncation with `[truncated]` indicator helps keep output readable
  - The formatter returns `null` for filtered lines, allowing easy skipping of system messages
  - Process chunks with line buffering to handle JSON split across chunks
---

## 2026-01-13 - US-020
- What was implemented: CLI entry point with proper argument handling
- Files changed:
  - source/cli.tsx - Added help text, -h handling, input validation, --log-file flag
  - source/app.tsx - Added logFile prop support
  - source/lib/claude-executor.ts - Added log file writing capability
  - source/types/config.ts - Added logFile to ClaudeExecutionOptions
  - source/utils/setup-checker.ts - Fixed ralph-plan skill path
- **Learnings:**
  - meow's `autoHelp` only handles `--help`, not `-h` - need manual handling for short flag
  - Use `Number.parseInt()` instead of `parseInt()` for stricter ES6 compliance
  - Input validation should provide clear error messages with the invalid value shown
  - Use `createWriteStream` with `{flags: 'a'}` for append mode when logging to files
  - The xo linter has a persistent bug with `unicorn/expiring-todo-comments` - typecheck is the reliable verification
---

## 2026-01-13 - US-023
- What was implemented: Fixed window growing beyond terminal size by using Ink's useStdout hook
- Files changed:
  - source/app.tsx - Added useStdout hook for terminal dimensions, resize event handling, height/width prop passing
  - source/components/MainLayout.tsx - Added height and terminalWidth props, overflow hidden, dynamic maxLines calculation
  - source/components/TabPanel.tsx - Added contentWidth prop to pass to child components
  - source/components/OutputPanel.tsx - Added calculateRenderedRows() for accurate row counting with ANSI stripping, fixed height box
  - source/components/ProgressLog.tsx - Added calculateRenderedRows() for accurate row counting, fixed height box
- **Learnings:**
  - Ink's `useStdout` hook returns `{stdout}` which has `rows` and `columns` properties for terminal dimensions
  - Register for `stdout.on('resize', handler)` to respond to terminal size changes, clean up with `.off()`
  - Use `overflow="hidden"` on Box components to prevent content from growing beyond fixed height
  - Multi-line output needs ANSI code stripping (`/\x1b\[[0-9;]*m/g`) for accurate length calculation
  - Calculate visible lines by counting actual rendered rows (width / content width) not just array length
  - Change `wrap="truncate"` to `wrap="wrap"` to allow proper line wrapping within fixed viewport
  - Set explicit `height={maxLines + 2}` on content boxes to account for border (2 rows)
---

## 2026-01-13 - US-023
- What was implemented: Filter output panel to show mainly assistant messages with extra messages only after the latest assistant message
- Files changed:
  - source/lib/stream-formatter.ts - Added `FormattedOutput` type with source tracking, `formatStreamLineWithSource()`, `createFilteringStreamFormatter()`, and `filterMessagesForDisplay()` functions
  - source/lib/iteration-executor.ts - Changed to use filtering stream formatter, updated output event type to emit `FormattedOutput[]`
  - source/app.tsx - Updated state to use `FormattedOutput[]`, added `useMemo` to convert to string[] for display
- **Learnings:**
  - Use a discriminated union type (`FormattedOutput`) with `source` field to track message origin (assistant/user/result)
  - Filtering logic: keep all assistant messages + all messages after the last assistant (shows "live" tool results)
  - When emitting filtered arrays, the receiver should replace (not append) to reflect the current filtered view
  - Add `source: 'assistant'` for synthetic messages (story start, iteration complete, errors) to ensure they persist in filtered view
  - The result type should always be included in filtered output (completion summary)
---

## 2026-01-13 - US-021
- What was implemented: Error boundary component and graceful error handling for the CLI
- Files changed:
  - source/components/ErrorBoundary.tsx - New component with ErrorBoundary class and ErrorDisplay functional component
  - source/components/index.ts - Added barrel export for ErrorBoundary and ErrorDisplay
  - source/types/state.ts - Added 'error' to AppView type
  - source/app.tsx - Integrated ErrorBoundary, added error view with retry/exit options, improved fatal error handling
- **Learnings:**
  - React error boundaries must be class components - they require `componentDidCatch` and `getDerivedStateFromError` lifecycle methods
  - Use `override` modifier on methods that override base class methods (required by TypeScript strict mode)
  - Prefix unused parameters with underscore (e.g., `_error`) to avoid TS6133 unused variable errors
  - Separate ErrorDisplay as a functional component for reuse in both ErrorBoundary fallback and explicit error view
  - Store `lastIterations` in state to enable retry functionality that resumes with same iteration count
  - The xo linter has a persistent bug with `unicorn/expiring-todo-comments` - `tsc --noEmit` is the reliable verification
---

## 2026-01-13 - US-024
- What was implemented: Fixed stop after iteration functionality to allow graceful stopping
- Files changed:
  - source/lib/iteration-executor.ts - Added `shouldStopAfterIteration` callback to IterationOptions, check after iterationComplete
  - source/app.tsx - Added stopAfterIterationRef, updated handleStopAfterIteration to set flag instead of aborting
- **Learnings:**
  - Use a callback function `() => boolean` instead of passing a mutable ref directly - allows cleaner decoupling between UI and executor
  - AbortSignal is for immediate cancellation (kills current process), use a separate mechanism for graceful stop
  - Check graceful stop flag after `iterationComplete` event is emitted, before the next iteration loop cycle starts
  - Reset the flag at the start of each execution run (`stopAfterIterationRef.current = false`) to ensure clean state
  - The existing UI footer already displays "Stopping after current iteration..." - just needed the backend to respect the flag
---

## 2026-01-13 - US-025
- What was implemented: Story ID detector module for parsing AI output to find which story was actually worked on
- Files changed:
  - source/lib/story-detector.ts - New module with detectStoryIdFromOutput() and extractStoryId() functions
  - source/lib/index.ts - Added barrel export for story-detector
- **Learnings:**
  - Use `Array.at(-1)` instead of `arr[arr.length - 1]` for safer last element access in TypeScript strict mode
  - When using regex matchAll(), the result is an iterator - spread to array with `[...output.matchAll(pattern)]`
  - Global regex patterns with `/g` flag are required for matchAll() to work correctly
  - TypeScript strict mode requires explicit null checks even after array length checks - use optional chaining `lastMatch?.[1]`
  - Return discriminated union type with `source: 'commit' | 'mention'` to indicate match origin for debugging
  - Commit message patterns should use case-insensitive flag `/gi` and handle both bracketed `[US-XXX]` and unbracketed `US-XXX` formats
---

## 2026-01-13 - US-026
- What was implemented: Raw output accumulation feature for the filtering stream formatter
- Files changed:
  - source/lib/stream-formatter.ts - Added getRawTextContent() method, stripAnsiCodes() helper, and extractRawAssistantContent() function
- **Learnings:**
  - Use a separate accumulator array (`rawTextParts`) for raw content vs. formatted output to keep concerns separated
  - Regex pattern `/\x1b\[[0-9;]*m/g` strips all ANSI escape sequences including color codes, bold, etc.
  - The `extractRawAssistantContent()` function reuses `summarizeToolInput()` for consistency in tool_use representation
  - Process raw content accumulation in the same loop as formatted output to avoid double-parsing JSON
  - Include tool_use names and input summaries in raw output because commit messages often appear in tool calls (like Bash)
  - Internal helper functions can be nested inside the factory function for encapsulation
---

## 2026-01-13 - US-027
- What was implemented: Updated iteration executor to detect and use the actual story ID from AI output
- Files changed:
  - source/lib/iteration-executor.ts - Added story detection logic after successful Claude execution, new events for mismatch and detection failure
  - source/app.tsx - Added event handlers for `storyMismatch` and `storyDetectionFailed` events with UI warnings
- **Learnings:**
  - Use `getRawTextContent()` from the stream formatter to get clean text for parsing (ANSI stripped)
  - Always verify detected story ID exists in the PRD before using it to avoid marking non-existent stories
  - Add new event types (`storyMismatch`, `storyDetectionFailed`) to the EventEmitter for clear separation of warning scenarios
  - When story mismatch occurs, update the UI story list to show the detected story as in-progress
  - Use `Array.some()` for existence checks in arrays - cleaner than `findIndex !== -1`
  - The xo linter bug with `unicorn/expiring-todo-comments` is still present - `tsc --noEmit` is the reliable verification
---

## 2026-01-13 - US-028
- What was implemented: Fixed TicketList overflow by adding width-based title truncation
- Files changed:
  - source/components/TicketList.tsx - Added `availableWidth` prop, `maxTitleLength` calculation, and truncation logic in TicketItem
  - source/components/MainLayout.tsx - Added `leftColumnWidth` calculation and passes it to TicketList as `availableWidth`
- **Learnings:**
  - Calculate available width for text by subtracting fixed overhead (status indicator, ID, separators) from column width
  - Use ellipsis character (`…`) for truncation indicator - it's a single character unlike `...` which is three
  - Fixed overhead calculation: 2 (status indicator + space) + 6 (story ID like US-XXX) + 3 (" - " separator) + 1 (padding) = 12 chars
  - Use `Math.max(10, calculatedWidth)` to ensure minimum readable title length even in narrow terminals
  - Props flow: terminalWidth -> MainLayout -> leftColumnWidth -> TicketList.availableWidth -> TicketItem.maxTitleLength
---

## 2026-01-14 - US-029
- What was implemented: Integrated iteration prompt into main screen by moving it to the footer
- Files changed:
  - source/types/state.ts - Simplified AppView type to 'setup' | 'no-prd' | 'main' | 'error'
  - source/components/KeyboardHelpFooter.tsx - Added iteration input with useInput hook and inline validation
  - source/components/index.ts - Removed IterationPrompt export
  - source/app.tsx - Removed 'iteration-prompt', 'running', 'complete' views; unified into single 'main' view
  - source/components/IterationPrompt.tsx - Deleted (functionality moved to KeyboardHelpFooter)
- **Learnings:**
  - Consolidating multiple similar views ('running', 'complete') into a single view with state flags (isRunning, completionReason) simplifies state management
  - useInput with `{isActive: boolean}` option allows conditional keyboard input handling - useful for enabling input only when not running
  - Pass callback as optional prop (`onStartIterations?: (...) => void`) and check for undefined to conditionally render input UI
  - For auto-start with CLI args, use a separate useEffect with limited deps to run only once when view changes
  - eslint-disable-next-line comment needed when intentionally limiting useEffect dependencies
---

## 2026-01-14 - US-030
- What was implemented: Updated README with accurate documentation for ralph-cli
- Files changed:
  - readme.md - Complete rewrite replacing create-ink-app template with actual project documentation
- **Learnings:**
  - README was named `readme.md` (lowercase) - git on macOS is case-insensitive for tracking
  - Run `npx prettier --write <file>` after editing markdown to ensure consistent formatting
  - Markdown tables need proper column alignment which prettier handles automatically
  - Include all CLI flags documented in source/cli.tsx helpText in the README
  - Quick Start section should cover the happy path: run -> setup wizard -> edit PRD -> run again
---

## 2026-01-14 - US-031
- What was implemented: Fixed JSON stream parser to validate messages before processing
- Files changed:
  - source/lib/stream-formatter.ts - Added isValidStreamMessage() type guard, updated parsing logic
  - test.ts - Added test cases for stream formatter JSON validation
- **Learnings:**
  - Using `as StreamMessage` without validation allows any JSON with a `type` field to be processed
  - Type guards with `obj is T` return type enable TypeScript to narrow types safely
  - Claude's stream-json format requires `message.content` array for assistant and user messages
  - Tool result content should be typed as `unknown` since it can be string or object (JSON files)
  - The xo linter bug with `unicorn/expiring-todo-comments` persists - use `tsc --noEmit` for verification
  - AVA + ts-node has compatibility issues with Node.js v24 - tests may fail to run but code is correct
---

## 2026-01-15 - US-032
- What was implemented: Beads types module for the beads migration
- Files changed:
  - source/types/beads.ts - New module with BeadsIssue, EpicSummary, BeadsCommandResult types
  - source/types/index.ts - Added barrel export for beads types
- **Learnings:**
  - BeadsStatus uses literal union type: `'open' | 'in_progress' | 'closed'`
  - BeadsPriority uses numeric literal union: `0 | 1 | 2 | 3 | 4` (0=critical, 4=backlog)
  - BeadsCommandResult uses discriminated union with `success: true/false` for typed error handling
  - The `parent` field in BeadsIssue is `string | undefined` to handle top-level issues
  - Created branch `ralph/beads-migration` from main for the migration work
---

## 2026-01-15 - US-033
- What was implemented: Beads reader module for bd command execution
- Files changed:
  - source/lib/beads-reader.ts - New module with bd command execution and parsing
  - source/lib/index.ts - Added barrel export for beads-reader
- **Learnings:**
  - bd CLI uses `--json` global flag for JSON output (not `--format=json`)
  - bd JSON output structure: `issue_type` (not `type`), `blocked_by` array for blockers
  - bd `list --parent=<id>` gets children, `ready --parent=<id>` gets unblocked children
  - bd `blocked --parent=<id>` returns issues with `blocked_by` array containing blocker IDs
  - bd `show <id> --refs` shows reverse references (what depends on this issue)
  - bd creates child IDs with dot notation: `epic-id.1`, `epic-id.2`, etc.
  - Dependencies come from `dependencies` array with `dependency_type: 'blocks' | 'parent-child'`
  - Use `existsSync('.beads')` to check if beads is initialized before running commands
  - Convert raw bd output to typed BeadsIssue using a `toBeadsIssue()` helper function
---

## 2026-01-15 - US-034
- What was implemented: useBeadsPolling hook for real-time beads status updates
- Files changed:
  - source/hooks/useBeadsPolling.ts - New hook with polling interval and cleanup
  - source/hooks/index.ts - Added barrel exports for hook and types
- **Learnings:**
  - Use `useRef(true)` for mounted state tracking to prevent updates after unmount
  - Set `mountedRef.current = true` at start of useEffect, `false` in cleanup
  - Use `void` prefix for async calls inside useEffect and setInterval (no await)
  - Export both the hook function and its associated types (BeadsPollingState, BeadsPollingOptions)
  - Default parameter value `intervalMs = 2500` provides sensible default in destructuring
  - Cleanup function clears interval with `clearInterval(intervalId)` to prevent memory leaks
---

## 2026-01-15 - US-035
- What was implemented: EpicSelector TUI component for selecting epics
- Files changed:
  - source/components/EpicSelector.tsx - New component with epic list, progress bars, keyboard nav
  - source/components/index.ts - Added barrel export for EpicSelector
- **Learnings:**
  - Use Ink's `inverse` prop on Text for highlighted selection appearance
  - Visual progress bars can use Unicode block characters: `█` (filled) and `░` (empty)
  - Prefix unused callback parameters with underscore (`_input`) to avoid TS6133 error
  - Component should handle all states: loading, error, empty list, and normal display
  - Use `&quot;` entity for quotes in JSX text content
  - EpicSummary type provides task counts for showing progress: `(closedCount / total) * 100`
---

## 2026-01-15 - US-036
- What was implemented: Branch management utilities for git operations
- Files changed:
  - source/utils/branch-utils.ts - New module with all branch utilities
  - source/utils/index.ts - Added barrel export for branch-utils
- **Learnings:**
  - Use `execSync` from `node:child_process` for synchronous git commands
  - `git rev-parse --abbrev-ref HEAD` returns "HEAD" when on detached HEAD state
  - `git rev-parse --verify refs/heads/<branch>` checks local branch existence
  - `git status --porcelain` gives machine-readable output for checking dirty worktree
  - `git checkout -b <branch> <base>` creates and switches in one command
  - Slugification pattern: lowercase -> replace non-alphanumeric with hyphens -> dedupe hyphens -> trim hyphens
  - Use `stdio: ['pipe', 'pipe', 'pipe']` to capture both stdout and stderr
---

## 2026-01-15 - US-037
- What was implemented: TaskDetailPanel component for displaying beads task details
- Files changed:
  - source/components/TaskDetailPanel.tsx - New component with task info, description, blockers
  - source/components/index.ts - Added barrel export for TaskDetailPanel
- **Learnings:**
  - Use default values in destructuring (`const [, indent = '', checked = ' '] = match`) to satisfy TypeScript strict undefined checks
  - Unicode checkbox characters: `☑` (checked) and `☐` (unchecked) work well in terminal UI
  - Markdown checklist regex: `/^(\s*)-\s*\[([ xX])\]\s*(.*)$/` captures indent, check state, and text
  - Reuse `calculateVisibleLines` from text-utils for scrollable description content
  - Status color mapping: closed=green, in_progress=yellow, open=gray follows traffic light convention
  - Use `dimColor` prop on Text for struck-through appearance on completed checklist items
---
