{
	"branchName": "ralph/interactive-cli-manager",
	"userStories": [
		{
			"id": "US-001",
			"title": "Create project structure and types",
			"acceptanceCriteria": [
				"Create types for PRD schema (UserStory, PRDConfig)",
				"Create types for application state",
				"Create types for configuration",
				"Create folder structure: source/components, source/hooks, source/utils, source/lib",
				"typecheck passes"
			],
			"priority": 1,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-002",
			"title": "Implement setup checker utility",
			"acceptanceCriteria": [
				"Function to check if .ralph directory exists",
				"Function to check if prompt.txt exists",
				"Function to check if prd.json exists",
				"Function to check if ralph-plan skill exists in .claude/skills",
				"Returns structured result indicating what is missing",
				"typecheck passes"
			],
			"priority": 2,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-003",
			"title": "Implement setup scaffolding utility",
			"acceptanceCriteria": [
				"Function to create .ralph directory",
				"Function to copy default prompt.txt template",
				"Function to create empty prd.json template",
				"Function to create progress.txt template",
				"Function to install ralph-plan skill in .claude/skills",
				"Each function is idempotent (safe to run multiple times)",
				"typecheck passes"
			],
			"priority": 3,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-004",
			"title": "Create Setup Wizard component",
			"acceptanceCriteria": [
				"Ink component that displays setup progress",
				"Shows checklist of setup items with status indicators",
				"Prompts user for confirmation before making changes",
				"Displays success/error messages for each step",
				"Transitions to main view or exits with instructions when done",
				"typecheck passes"
			],
			"priority": 4,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-005",
			"title": "Create PRD file reader and parser",
			"acceptanceCriteria": [
				"Function to read and parse prd.json",
				"Validates JSON structure against types",
				"Returns typed PRDConfig object",
				"Handles file not found gracefully",
				"Handles malformed JSON gracefully",
				"typecheck passes"
			],
			"priority": 5,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-006",
			"title": "Create PRD file writer",
			"acceptanceCriteria": [
				"Function to write PRDConfig to prd.json",
				"Function to update single story status (passes, notes)",
				"Preserves formatting (pretty print)",
				"typecheck passes"
			],
			"priority": 6,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-007",
			"title": "Create TicketList component",
			"acceptanceCriteria": [
				"Ink component that displays list of user stories",
				"Shows story ID, title, and status (pending/in-progress/passed)",
				"Uses color coding: green for passed, yellow for in-progress, gray for pending",
				"Highlights currently executing story",
				"Scrollable if list exceeds viewport",
				"typecheck passes"
			],
			"priority": 7,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-008",
			"title": "Implement Claude execution wrapper",
			"acceptanceCriteria": [
				"Function to spawn Claude CLI process",
				"Passes prompt with correct parameters (--dangerously-skip-permissions, --output-format stream-json)",
				"Streams stdout to provided callback",
				"Returns promise that resolves when process completes",
				"Handles process termination gracefully",
				"typecheck passes"
			],
			"priority": 8,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-009",
			"title": "Implement output parser for Claude stream",
			"acceptanceCriteria": [
				"Function to parse JSON stream lines from Claude",
				"Extracts text content from content_block_delta events",
				"Extracts result summary from result events",
				"Filters out metadata events (system, message_start, etc.)",
				"Returns parsed content string",
				"typecheck passes"
			],
			"priority": 9,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-010",
			"title": "Create OutputPanel component",
			"acceptanceCriteria": [
				"Ink component that displays streaming output",
				"Shows live Claude output with proper formatting",
				"Auto-scrolls to latest content",
				"Has configurable max lines/buffer size",
				"typecheck passes"
			],
			"priority": 10,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-011",
			"title": "Create ProgressLog component",
			"acceptanceCriteria": [
				"Ink component that displays progress.txt content",
				"Tails the file for live updates",
				"Auto-scrolls to latest content",
				"typecheck passes"
			],
			"priority": 11,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-012",
			"title": "Create TabPanel component",
			"acceptanceCriteria": [
				"Ink component with tab navigation",
				"Two tabs: 'Output' and 'Progress Log'",
				"Shows tab headers with active indicator",
				"Renders appropriate content panel based on active tab",
				"typecheck passes"
			],
			"priority": 12,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-013",
			"title": "Create MainLayout component",
			"acceptanceCriteria": [
				"Ink component with two-column layout",
				"Left column: TicketList",
				"Right column: TabPanel (Output/Progress)",
				"Proper flex sizing (left ~30%, right ~70%)",
				"typecheck passes"
			],
			"priority": 13,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-014",
			"title": "Implement iteration prompt dialog",
			"acceptanceCriteria": [
				"Ink component that prompts for number of iterations",
				"Input validation (must be positive integer)",
				"Default value suggestion",
				"Callback when user confirms",
				"typecheck passes"
			],
			"priority": 14,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-015",
			"title": "Implement iteration execution loop",
			"acceptanceCriteria": [
				"Function that runs N iterations",
				"Finds highest priority incomplete story for each iteration",
				"Calls Claude execution wrapper with proper prompt",
				"Updates story status on completion",
				"Emits events for UI updates",
				"Stops early if all stories complete",
				"typecheck passes"
			],
			"priority": 15,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-016",
			"title": "Implement keyboard controls",
			"acceptanceCriteria": [
				"useInput hook for keyboard handling",
				"Tab key switches between Output/Progress tabs",
				"Ctrl+C cancels immediately",
				"Ctrl+X or 'q' stops after current iteration completes",
				"Shows keybinding help in footer",
				"typecheck passes"
			],
			"priority": 16,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-017",
			"title": "Implement prompt template loader",
			"acceptanceCriteria": [
				"Function to load prompt.txt from .ralph directory",
				"Falls back to bundled default prompt if not found",
				"Variable expansion for $PRD_FILE and $PROGRESS_FILE",
				"typecheck passes"
			],
			"priority": 17,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-018",
			"title": "Integrate all components into App",
			"acceptanceCriteria": [
				"App component orchestrates full flow",
				"Runs setup wizard if needed",
				"Shows 'no PRD' message if prd.json missing after setup",
				"Shows main view with iteration prompt if PRD exists",
				"Manages state for current iteration, output, etc.",
				"typecheck passes"
			],
			"priority": 18,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-019",
			"title": "Bundle default templates",
			"acceptanceCriteria": [
				"Include default prompt.txt in package",
				"Include default prd.json template in package",
				"Include ralph-plan skill template in package",
				"Templates accessible at runtime via import or file read",
				"typecheck passes"
			],
			"priority": 19,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-022",
			"title": "Format Claude stream-json output for CLI display",
			"acceptanceCriteria": [
				"Parse top-level message types: system, assistant, user",
				"Format assistant text content with proper styling",
				"Format tool_use messages showing tool name and summarized input",
				"Format tool_result messages with success/error indication",
				"Handle nested content arrays in assistant messages",
				"Extract and display cost/usage info from message metadata",
				"Color coding: tool names in cyan, errors in red, success in green",
				"Truncate long tool inputs/outputs with expandable indicator",
				"typecheck passes"
			],
			"priority": 19,
			"passes": true,
			"notes": "Reference output.json for example format. Top-level types are assistant/user/system, with content arrays containing text/tool_use/tool_result items."
		},
		{
			"id": "US-023",
			"title": "Fix window growing beyond terminal size",
			"acceptanceCriteria": [
				"Use useStdout hook from Ink to get terminal dimensions (rows, columns)",
				"Set fixed height on MainLayout based on terminal rows",
				"OutputPanel and ProgressLog respect available height",
				"Multi-line formatted output counts actual rendered rows not array length",
				"Content scrolls within fixed viewport instead of growing",
				"Handle terminal resize events",
				"typecheck passes"
			],
			"priority": 19,
			"passes": true,
			"notes": "Bug: With multi-line formatted output (tool calls etc), each 'line' in the array can wrap to multiple terminal rows, causing the UI to grow beyond terminal height."
		},
		{
			"id": "US-020",
			"title": "Update CLI entry point",
			"acceptanceCriteria": [
				"Update cli.tsx with proper argument handling",
				"Support: ralph-cli (interactive mode)",
				"Support: ralph-cli <number> (run N iterations)",
				"Support: ralph-cli --help/-h",
				"typecheck passes"
			],
			"priority": 20,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-023",
			"title": "Filter output panel to show mainly assistant messages with extra messages only for all messages after the latest assistant message",
			"acceptanceCriteria": [
				"Filter output panel to show mainly assistant messages with extra messages only for all messages after the latest assistant message",
				"typecheck passes"
			],
			"priority": 19,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-021",
			"title": "Add error boundary and graceful error handling",
			"acceptanceCriteria": [
				"Error boundary component for React errors",
				"Graceful handling of Claude process errors",
				"Clear error messages displayed to user",
				"Option to retry or exit on error",
				"typecheck passes"
			],
			"priority": 21,
			"passes": true,
			"notes": ""
		},
		{
			"id": "US-024",
			"title": "Fix stop after iteration functionality",
			"acceptanceCriteria": [
				"Debug why abort signal is not stopping execution between iterations",
				"Verify abortSignal.aborted check at top of iteration loop is working",
				"Add separate 'stopAfterIteration' flag that doesn't kill current process",
				"Pass stopAfterIteration flag to runIterations via options or separate signal",
				"Check flag after each iterationComplete before starting next iteration",
				"Current Claude execution should complete normally when flag is set",
				"Show 'Stopping after this iteration...' message in footer when flag is set",
				"Ctrl+C still aborts immediately (unchanged)",
				"typecheck passes"
			],
			"priority": 22,
			"passes": true,
			"notes": "Bug: UI shows 'stopping after iteration' but execution continues to next iteration anyway. The isStopping state is set but runIterations doesn't receive this flag - it only gets the AbortSignal. Need separate mechanism to signal graceful stop vs immediate abort."
		},
		{
			"id": "US-025",
			"title": "Create story ID detector from AI output",
			"acceptanceCriteria": [
				"Create new source/lib/story-detector.ts module",
				"Function detectStoryIdFromOutput(output: string) that returns story ID or null",
				"Pattern matching for commit messages: feat: [US-XXX] or feat: US-XXX",
				"Pattern matching for general story ID mentions: US-001, US-002, etc.",
				"Prioritize commit message matches over general mentions",
				"Return last matched ID if multiple found (most recent work)",
				"Return null if no story ID found in output",
				"typecheck passes"
			],
			"priority": 23,
			"passes": true,
			"notes": "Bug context: The prompt generator ignores the story argument (prompt-loader.ts:100-105), so the AI picks its own story from the PRD. The system then marks the wrong story as complete. This detector will parse AI output to find which story was actually worked on."
		},
		{
			"id": "US-026",
			"title": "Add raw output accumulation to stream formatter",
			"acceptanceCriteria": [
				"Add getRawTextContent() method to createFilteringStreamFormatter()",
				"Accumulate all assistant text content (not tool calls) during processing",
				"Strip ANSI codes from accumulated text for clean parsing",
				"Include tool_use names and descriptions in raw output for context",
				"Return concatenated string of all text content after execution",
				"typecheck passes"
			],
			"priority": 24,
			"passes": true,
			"notes": "This provides the raw text output needed by story-detector to find which story the AI worked on."
		},
		{
			"id": "US-027",
			"title": "Update iteration executor to use detected story ID",
			"acceptanceCriteria": [
				"After Claude execution succeeds, call detectStoryIdFromOutput() with accumulated text",
				"If story ID detected: use that ID to update PRD instead of pre-selected nextStory.id",
				"If story ID detected differs from nextStory.id: log warning about mismatch",
				"If no story ID detected: fall back to nextStory.id (current behavior) with warning",
				"Emit storyComplete event with the detected/used story ID",
				"Update UI to show detected story as in-progress when changed",
				"typecheck passes"
			],
			"priority": 25,
			"passes": true,
			"notes": "This fixes the core bug: marking the story the AI actually worked on as complete, not the one the system pre-selected."
		},
		{
			"id": "US-028",
			"title": "Fix TicketList overflow and text truncation",
			"acceptanceCriteria": [
				"Pass terminalWidth to TicketList component from MainLayout",
				"Calculate available width for left column (30% of terminal minus padding)",
				"Truncate story titles to fit within available width with ellipsis",
				"Account for status indicator and story ID in width calculation",
				"Ensure no text wraps or overflows into right panel",
				"typecheck passes"
			],
			"priority": 26,
			"passes": true,
			"notes": "Bug: Long story titles wrap to multiple lines causing messy layout with text overflowing the column boundaries."
		}
	]
}
